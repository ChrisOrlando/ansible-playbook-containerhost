---
# adds a header (X-Hostname) to all request
# sometimes turned off to hide a servers name when a server is behind cloudflare
apache_hostname_header: true

# for CVE-2014-3566 aka POODLE aka poodlebleed (lol) we're disabling SSLv3 on
# all servers. SSLv2 is already disabled and has been for a long time.
apache_forbidden_ssl_tls_protocols: ['SSLv2', 'SSLv3']

# some people use mod_spdy which loads its own ssl stuff so this would be set to
# false on those servers
apache_load_mod_ssl: true

# using the "Intermediate compatibility" one from
# https://wiki.mozilla.org/Security/Server_Side_TLS
#
apache_ssl_cipher_suite: 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS:!3DES'

apache::logrotate:
  path: '/var/log/httpd/*log'
  rotate_every: 'day'
  rotate: '7'
  minsize: '25M'
  missingok: true
  ifempty: false
  sharedscripts: true
  compress: true
  delaycompress: true
  postrotate: '/sbin/service httpd reload > /dev/null 2>/dev/null || true'

apache::server_status:
  ExtendedStatus: 'Off'
  allow_from_list:
    - '127.0.0.1'
    - '0:0:0:0:0:0:0:1'
  deny_from_list:
    - 'all'

apache::httpd_conf_prefork:location:
  - nl-west-1
  - uk-south-1
  - uk-south-2
  - au-east-1
  - au-south-1
  - us-midwest-1
  - us-south-1
  - us-south-2
  - us-west-1
  ## - ord

apache::deflate_expire_defaults:
   managed_conf_file:      true

apache::httpd_conf_prefork_template: true

apache::httpd_conf:
   managed_conf_file:      true
   User:                   "apache"
   Group:                  "apache"
   LogLevel:               "warn"
   Listen:                 80
   Timeout:                60
   DocumentRoot:           "/var/www/html"
   root_level_overrides:   "All"
   mpm:                    "prefork"
   mpm_prefork:
      StartServers:           64
      MinSpareServers:        32
      MaxSpareServers:        64
      ServerLimit:            1024
      MaxClients:             256
      MaxRequestsPerChild:    4096
   HostnameLookups:        "Off"
   KeepAlive:              "On"
   MaxKeepAliveRequests:   100
   KeepAliveTimeout:       15
   LogFormats:
      # These aren't actually used, check the template you're working with.
      # They aren't used because putting a literal % in hiera stuff is.... awkward
      # see here: https://puppet.com/docs/hiera/3.3/variables.html#the-literal-lookup-function
      # The correct way to do it is apparently %{literal('%')}
      combined:   '%a %{X-Forwarded-For}i %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"'
      common:     '%a %l %u %t \"%r\" %>s %b'
      referer:    '%{Referer}i -> %U'
      agent:      '%%{User-agent}i'
   CustomLog:     'logs/access_log combined'
   DirectoryIndex:         "index.php index.html index.htm default.html default.htm"
   IndexOptions:           "FancyIndexing VersionSort NameWidth=* HTMLTable Charset=UTF-8"
   AccessFileName:         ".htaccess"
   AddTypes:
      application/x-compress:       ".Z"
      application/x-gzip:           ".gz .tgz"
      application/x-x509-ca-cert:   ".crt"
      application/x-pkcs7-crl:      ".crl"
      text/html:                    ".shtml"
   modules_blacklist:
      - asis
      - authn_dbd
      - authz_svn
      - cache
      - cern_meta
      - cgid
      - dav_fs
      - dav_svn
      - dbd
      - disk_cache
      - dumpio
      - ext_filter
      - fastcgi
      - filter
      - ident
      - log_forensic
      - mem_cache
      - proxy_scgi
      - reqtimeout
      - security2
      - speling
      - ssl
      - suphp
      - unique_id
      - usertrack
      - watch
      - wsgi

apache::httpd_conf_prefork:
   mpm_prefork_32:
      StartServers:        20
      MaxSpareServers:     20
      MinSpareServers:     8
      ServerLimit:         1024
      MaxClients:          768
      MaxRequestsPerChild: 8192
   mpm_prefork_16:
      StartServers:        16
      MaxSpareServers:     16
      MinSpareServers:     6
      ServerLimit:         1024
      MaxClients:          512
      MaxRequestsPerChild: 8192
   mpm_prefork_8:
      StartServers:        12
      MaxSpareServers:     12
      MinSpareServers:     4
      ServerLimit:         768
      MaxClients:          384
      MaxRequestsPerChild: 8192
   mpm_prefork_4:
      StartServers:        8
      MaxSpareServers:     8
      MinSpareServers:     2
      ServerLimit:         512
      MaxClients:          256
      MaxRequestsPerChild: 4096
   mpm_prefork_4_below:
      StartServers:        4
      MaxSpareServers:     4
      MinSpareServers:     1
      ServerLimit:         256
      MaxClients:          128
      MaxRequestsPerChild: 4096
   managed_conf_file:      true
   User:                   "apache"
   Group:                  "apache"
   LogLevel:               "warn"
   Listen:                 80
   Timeout:                60
   DocumentRoot:           "/var/www/html"
   root_level_overrides:   "None"
   HostnameLookups:        "Off"
   KeepAlive:              "On"
   MaxKeepAliveRequests:   100
   KeepAliveTimeout:       5
   LogFormats:
      # These aren't actually used, check the template you're working with.
      # They aren't used because putting a literal % in hiera stuff is.... awkward
      # see here: https://puppet.com/docs/hiera/3.3/variables.html#the-literal-lookup-function
      # The correct way to do it is apparently %{literal('%')}
      combined:   '%a %{X-Forwarded-For}i - %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"'
      common:     '%a %l %u %t \"%r\" %>s %b'
      referer:    '%{Referer}i -> %U'
      agent:      '%%{User-agent}i'
   CustomLog:     'logs/access_log combined'
   DirectoryIndex:         "index.php index.html index.htm default.html default.htm"
   IndexOptions:           "FancyIndexing VersionSort NameWidth=* HTMLTable Charset=UTF-8"
   AccessFileName:         ".htaccess"
   AddTypes:
      application/x-compress:       ".Z"
      application/x-gzip:           ".gz .tgz"
      application/x-x509-ca-cert:   ".crt"
      application/x-pkcs7-crl:      ".crl"
      text/html:                    ".shtml"
   modules_blacklist:
      - asis
      - authn_dbd
      - authz_svn
      - cache
      - cern_meta
      - cgid
      - dav_fs
      - dav_svn
      - dbd
      - disk_cache
      - dumpio
      - ext_filter
      - fastcgi
      - filter
      - ident
      - log_forensic
      - mem_cache
      - proxy_scgi
      - reqtimeout
      - security2
      - speling
      - ssl
      - suphp
      - unique_id
      - usertrack
      - watch
      - wsgi


apache::modsec_ipdb_logrotate:
  path: '/var/lib/mod_security/ip.pag'
  rotate_every: 'day'
  size: '100k'
  rotate: '0'
  prerotate: '/usr/bin/modsec-sdbm-util -n -D /var/lib/mod_security /var/lib/mod_security/ip.pag'
  postrotate: >
        mv /var/lib/mod_security/{new_db.dir,ip.dir};
        mv /var/lib/mod_security/{new_db.pag,ip.pag};
        chown apache:apache /var/lib/mod_security/ip.{dir,pag};
        chmod 0640 /var/lib/mod_security/ip.{dir,pag};
